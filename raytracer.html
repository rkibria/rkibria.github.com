<!DOCTYPE html>
<html>
<body>

<script src="js/three.min.js"></script>

<canvas id="myCanvas" width="300" height="300" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>

<script>

var SCREEN_WIDTH = 300;
var SCREEN_HEIGHT = 300;

var camera = {
	pos: new THREE.Vector3(0, 0, 0),
	point: new THREE.Vector3(0, 0, -10),
	fov: 45.0
	};

var sphere = new THREE.Sphere(new THREE.Vector3(0, 0, -5), 1);

var light = new THREE.Vector3(0, 10, 0);

var VECTOR_UP = new THREE.Vector3(0, 1, 0);

var eyeVector = new THREE.Vector3();
eyeVector.subVectors(camera.point, camera.pos).normalize();
console.log("eyeVector", eyeVector);

var eyeRightVector = new THREE.Vector3();
eyeRightVector.crossVectors(eyeVector, VECTOR_UP).normalize();
console.log("eyeRightVector", eyeRightVector);

var eyeUpVector = new THREE.Vector3();
eyeUpVector.crossVectors(eyeRightVector, eyeVector).normalize();
console.log("eyeUpVector", eyeUpVector);

var fovRadians = Math.PI * (camera.fov / 2) / 180,
heightWidthRatio = SCREEN_WIDTH / SCREEN_HEIGHT,
halfWidth = Math.tan(fovRadians),
halfHeight = heightWidthRatio * halfWidth,
camerawidth = halfWidth * 2,
cameraheight = halfHeight * 2,
pixelWidth = camerawidth / (SCREEN_WIDTH - 1),
pixelHeight = cameraheight / (SCREEN_HEIGHT - 1);


var c = document.getElementById("myCanvas");
var ctx = c.getContext("2d");    
ctx.fillStyle="black";
ctx.fillRect(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);

var imgData = ctx.getImageData(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT);
console.log(imgData.data.length);

var i;
var xcomp = new THREE.Vector3();
var ycomp = new THREE.Vector3();
var rayDirection = new THREE.Vector3();
var intersectVector = new THREE.Vector3();
var surfaceNormal = new THREE.Vector3();
var lightVector = new THREE.Vector3();
var eyeRay = new THREE.Ray();

for (i = 0; i < imgData.data.length; i += 4) {
	var x = (i / 4) % SCREEN_WIDTH;
	var y = (i / (4 * SCREEN_HEIGHT));

	xcomp.copy(eyeRightVector);
	xcomp.multiplyScalar((x * pixelWidth) - halfWidth);

	ycomp.copy(eyeUpVector);
	ycomp.multiplyScalar((y * pixelHeight) - halfHeight);

	rayDirection.copy(eyeVector);
	rayDirection.add(xcomp);
	rayDirection.add(ycomp).normalize();

	eyeRay.set(camera.pos, rayDirection);

	var color = 0;
	var intersect = eyeRay.intersectSphere(sphere, intersectVector);
	if (intersect != null) {
		surfaceNormal.copy(intersectVector);
		surfaceNormal.sub(sphere.center).normalize();

		lightVector.copy(light);
		lightVector.sub(intersectVector).normalize();

		color = surfaceNormal.dot(lightVector);
	}

	imgData.data[i] = color * 255;
	imgData.data[i+1] = color * 255;
	imgData.data[i+2] = color * 255;
	imgData.data[i+3] = 255;
}

ctx.putImageData(imgData, 0, 0);

</script>

</body>
</html>
