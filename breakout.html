<!doctype html>
<html>

<head>
<meta charset="utf-8">
<title>Three.js Breakout</title>
</head>

<body>

<div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div>

<script src="js/three.min.js"></script>
<script src="js/Detector.js"></script>
<script src="js/stats.min.js"></script>
<script src="js/threex.windowresize.js"></script>

<script>
"use strict";

// CONSTS
const SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;

// SCENE
const scene = new THREE.Scene();

// CAMERA
const VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.1, FAR = 20000;
const camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
camera.position.x = 0;
camera.position.y = 3;
camera.position.z = 10;

// RENDERER
let renderer = null;
if ( Detector.webgl )
	renderer = new THREE.WebGLRenderer( {antialias:true} );
else
	renderer = new THREE.CanvasRenderer();
renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
const container = document.getElementById( 'ThreeJS' );
container.appendChild( renderer.domElement );

// EVENTS
THREEx.WindowResize(renderer, camera);

// STATS
const stats = new Stats();
stats.domElement.style.position = 'absolute';
stats.domElement.style.bottom = '0px';
stats.domElement.style.zIndex = 100;
container.appendChild( stats.domElement );

// LIGHT
var light = new THREE.PointLight(0xffffff, 1, 0);
light.position.set( 0, 100, 0 );
scene.add( light );

const ambLight = new THREE.AmbientLight(0xaaaaaa);
scene.add(ambLight);

// GEOMETRY
const BORDER_X = 8;
const BALL_RADIUS = 0.3;
const BORDER_Z = 30;

const groundPlane = new THREE.Mesh(
	new THREE.PlaneGeometry( 80, 80, 20, 20 ),
	new THREE.MeshBasicMaterial( {color: 0x00f000, side: THREE.DoubleSide, wireframe: true, transparent: true, opacity: 0.1} )
	);
groundPlane.position.y = -0.5;
groundPlane.rotation.x = Math.PI/2;
scene.add( groundPlane );

const ball = new THREE.Mesh( new THREE.SphereGeometry( BALL_RADIUS, 16, 16 ), new THREE.MeshLambertMaterial( {color: 0xa00000} ) );
scene.add( ball );

const bat = new THREE.Mesh( new THREE.BoxGeometry( 2, 0.5, 1 ), new THREE.MeshLambertMaterial( {color: 0xa0a0a0} ) );
scene.add( bat );

const leftBorder = new THREE.Mesh( new THREE.BoxGeometry( 0.25, 0.5, 30 ), new THREE.MeshLambertMaterial( {color: 0x606060} ) );
leftBorder.position.x = -BORDER_X;
leftBorder.position.z = -15;
scene.add( leftBorder );

const rightBorder = new THREE.Mesh( new THREE.BoxGeometry( 0.25, 0.5, 30 ), new THREE.MeshLambertMaterial( {color: 0x606060} ) );
rightBorder.position.x = BORDER_X;
rightBorder.position.z = -15;
scene.add( rightBorder );

const topBorder = new THREE.Mesh( new THREE.BoxGeometry( 16, 0.5, 0.25 ), new THREE.MeshLambertMaterial( {color: 0x606060} ) );
topBorder.position.z = -BORDER_Z;
scene.add( topBorder );

// GAME DATA
let batX = 0;
const ballSpeed = new THREE.Vector2();

function resetBall() {
	ballSpeed.x = 8;
	ballSpeed.y = -8;
	ball.position.x = -BORDER_X/2 + Math.random() * BORDER_X/2;
	ball.position.z = -3;
}
resetBall();

// MOUSE
function onMouseMove(e) {
	let x = e.pageX;
	const margin = window.innerWidth / 4;
	x = Math.max(margin, x);
	x = Math.min(window.innerWidth - margin, x);
	batX = (x - margin) / (window.innerWidth - 2 * margin);
}

window.onload = function() {
	this.addEventListener('mousemove', onMouseMove);
}

// RENDER LOOP
var clock = new THREE.Clock();
function render() {
	requestAnimationFrame( render );
	stats.update();
	const deltaT = clock.getDelta();

	bat.position.x = -6.5 + 13 * batX;

	// Move ball
	ball.position.x += ballSpeed.x * deltaT;
	ball.position.z += ballSpeed.y * deltaT;
	const maxRight = BORDER_X - BALL_RADIUS;
	const maxLeft = -BORDER_X + BALL_RADIUS;
	if (ball.position.x > maxRight) {
		ball.position.x = maxRight;
		ballSpeed.x *= -1;
	}
	else if (ball.position.x < maxLeft) {
		ball.position.x = maxLeft;
		ballSpeed.x *= -1;
	}
	const maxTop = -BORDER_Z + BALL_RADIUS;
	if (ball.position.z < maxTop) {
		ball.position.z = maxTop;
		ballSpeed.y *= -1;
	}
	else if (ball.position.z > 3) {
		resetBall();
	}

	renderer.render(scene, camera);
};
render();

</script>

</body>

</html>
